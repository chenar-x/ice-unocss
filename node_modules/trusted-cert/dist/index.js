/*!
 * trusted-cert.js v1.1.3
 * (c) 2020-2021 [object Object]
 * Released under the MIT License.
 */
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("fs"),t=require("inquirer"),r=require("command-exists"),n=require("debug"),o=require("path"),a=require("os"),i=require("child_process"),s=require("fs-extra"),c=require("rimraf"),u=require("moment"),l=require("node-forge"),d=require("util");function f(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var p=f(e),_=f(t),h=f(n),v=f(o),y=f(a),g=f(s),m=f(u),x=f(l);function w(e,t,r,n,o,a,i){try{var s=e[a](i),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,o)}function b(e){return function(){var t=this,r=arguments;return new Promise((function(n,o){var a=e.apply(t,r);function i(e){w(a,n,o,i,s,"next",e)}function s(e){w(a,n,o,i,s,"throw",e)}i(void 0)}))}}var k,S=(function(e){var t=function(e){var t,r=Object.prototype,n=r.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},a=o.iterator||"@@iterator",i=o.asyncIterator||"@@asyncIterator",s=o.toStringTag||"@@toStringTag";function c(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{c({},"")}catch(e){c=function(e,t,r){return e[t]=r}}function u(e,t,r,n){var o=t&&t.prototype instanceof v?t:v,a=Object.create(o.prototype),i=new O(n||[]);return a._invoke=function(e,t,r){var n=d;return function(o,a){if(n===p)throw new Error("Generator is already running");if(n===_){if("throw"===o)throw a;return L()}for(r.method=o,r.arg=a;;){var i=r.delegate;if(i){var s=P(i,r);if(s){if(s===h)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(n===d)throw n=_,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n=p;var c=l(e,t,r);if("normal"===c.type){if(n=r.done?_:f,c.arg===h)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n=_,r.method="throw",r.arg=c.arg)}}}(e,r,i),a}function l(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=u;var d="suspendedStart",f="suspendedYield",p="executing",_="completed",h={};function v(){}function y(){}function g(){}var m={};m[a]=function(){return this};var x=Object.getPrototypeOf,w=x&&x(x(j([])));w&&w!==r&&n.call(w,a)&&(m=w);var b=g.prototype=v.prototype=Object.create(m);function k(e){["next","throw","return"].forEach((function(t){c(e,t,(function(e){return this._invoke(t,e)}))}))}function S(e,t){function r(o,a,i,s){var c=l(e[o],e,a);if("throw"!==c.type){var u=c.arg,d=u.value;return d&&"object"==typeof d&&n.call(d,"__await")?t.resolve(d.__await).then((function(e){r("next",e,i,s)}),(function(e){r("throw",e,i,s)})):t.resolve(d).then((function(e){u.value=e,i(u)}),(function(e){return r("throw",e,i,s)}))}s(c.arg)}var o;this._invoke=function(e,n){function a(){return new t((function(t,o){r(e,n,t,o)}))}return o=o?o.then(a,a):a()}}function P(e,r){var n=e.iterator[r.method];if(n===t){if(r.delegate=null,"throw"===r.method){if(e.iterator.return&&(r.method="return",r.arg=t,P(e,r),"throw"===r.method))return h;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return h}var o=l(n,e.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,h;var a=o.arg;return a?a.done?(r[e.resultName]=a.value,r.next=e.nextLoc,"return"!==r.method&&(r.method="next",r.arg=t),r.delegate=null,h):a:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,h)}function E(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function $(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function O(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(E,this),this.reset(!0)}function j(e){if(e){var r=e[a];if(r)return r.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var o=-1,i=function r(){for(;++o<e.length;)if(n.call(e,o))return r.value=e[o],r.done=!1,r;return r.value=t,r.done=!0,r};return i.next=i}}return{next:L}}function L(){return{value:t,done:!0}}return y.prototype=b.constructor=g,g.constructor=y,y.displayName=c(g,s,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===y||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,g):(e.__proto__=g,c(e,s,"GeneratorFunction")),e.prototype=Object.create(b),e},e.awrap=function(e){return{__await:e}},k(S.prototype),S.prototype[i]=function(){return this},e.AsyncIterator=S,e.async=function(t,r,n,o,a){void 0===a&&(a=Promise);var i=new S(u(t,r,n,o),a);return e.isGeneratorFunction(r)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},k(b),c(b,s,"Generator"),b[a]=function(){return this},b.toString=function(){return"[object Generator]"},e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=j,O.prototype={constructor:O,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach($),!e)for(var r in this)"t"===r.charAt(0)&&n.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=t)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var r=this;function o(n,o){return s.type="throw",s.arg=e,r.next=n,o&&(r.method="next",r.arg=t),!!o}for(var a=this.tryEntries.length-1;a>=0;--a){var i=this.tryEntries[a],s=i.completion;if("root"===i.tryLoc)return o("end");if(i.tryLoc<=this.prev){var c=n.call(i,"catchLoc"),u=n.call(i,"finallyLoc");if(c&&u){if(this.prev<i.catchLoc)return o(i.catchLoc,!0);if(this.prev<i.finallyLoc)return o(i.finallyLoc)}else if(c){if(this.prev<i.catchLoc)return o(i.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return o(i.finallyLoc)}}}},abrupt:function(e,t){for(var r=this.tryEntries.length-1;r>=0;--r){var o=this.tryEntries[r];if(o.tryLoc<=this.prev&&n.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var a=o;break}}a&&("break"===e||"continue"===e)&&a.tryLoc<=t&&t<=a.finallyLoc&&(a=null);var i=a?a.completion:{};return i.type=e,i.arg=t,a?(this.method="next",this.next=a.finallyLoc,h):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),h},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),$(r),h}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var o=n.arg;$(r)}return o}}throw new Error("illegal catch attempt")},delegateYield:function(e,r,n){return this.delegate={iterator:j(e),resultName:r,nextLoc:n},"next"===this.method&&(this.arg=t),h}},e}(e.exports);try{regeneratorRuntime=t}catch(e){Function("r","regeneratorRuntime = r")(t)}}(k={exports:{}},k.exports),k.exports);function P(e){if("string"!=typeof e)throw new TypeError("`name` must be string");switch(y.default.platform()){case"darwin":return v.default.join(process.env.HOME,".trusted-cert");case"linux":return function(e){return null!=process.env.XDG_CONFIG_HOME?v.default.join(process.env.XDG_CONFIG_HOME,e):v.default.join(process.env.HOME,".config",e)}(e);case"win32":return function(e){return null!=process.env.LOCALAPPDATA?v.default.join(process.env.LOCALAPPDATA,e):v.default.join(process.env.USERPROFILE,"Local Settings","Application Data",e)}(e)}throw new Error("Platform not supported")}var E=P("trusted-cert"),$=v.default.join(E,"./ssl.cnf"),O=v.default.join(E,"./ssl.key"),j=v.default.join(E,"./ssl.crt"),L="generated by trusted-cert",N=["localhost"],A=function(){return{sslCertificateDir:E,sslConfigFile:$,sslKeyPath:O,sslCrtPath:j,CN:L,defaultDomains:N}};const D=e=>e&&e.includeBoundaries?"(?:(?<=\\s|^)(?=[a-fA-F\\d:])|(?<=[a-fA-F\\d:])(?=\\s|$))":"",F="(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)(?:\\.(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)){3}",C="[a-fA-F\\d]{1,4}",T=`\n(?:\n(?:${C}:){7}(?:${C}|:)|                                    // 1:2:3:4:5:6:7::  1:2:3:4:5:6:7:8\n(?:${C}:){6}(?:${F}|:${C}|:)|                             // 1:2:3:4:5:6::    1:2:3:4:5:6::8   1:2:3:4:5:6::8  1:2:3:4:5:6::1.2.3.4\n(?:${C}:){5}(?::${F}|(?::${C}){1,2}|:)|                   // 1:2:3:4:5::      1:2:3:4:5::7:8   1:2:3:4:5::8    1:2:3:4:5::7:1.2.3.4\n(?:${C}:){4}(?:(?::${C}){0,1}:${F}|(?::${C}){1,3}|:)| // 1:2:3:4::        1:2:3:4::6:7:8   1:2:3:4::8      1:2:3:4::6:7:1.2.3.4\n(?:${C}:){3}(?:(?::${C}){0,2}:${F}|(?::${C}){1,4}|:)| // 1:2:3::          1:2:3::5:6:7:8   1:2:3::8        1:2:3::5:6:7:1.2.3.4\n(?:${C}:){2}(?:(?::${C}){0,3}:${F}|(?::${C}){1,5}|:)| // 1:2::            1:2::4:5:6:7:8   1:2::8          1:2::4:5:6:7:1.2.3.4\n(?:${C}:){1}(?:(?::${C}){0,4}:${F}|(?::${C}){1,6}|:)| // 1::              1::3:4:5:6:7:8   1::8            1::3:4:5:6:7:1.2.3.4\n(?::(?:(?::${C}){0,5}:${F}|(?::${C}){1,7}|:))             // ::2:3:4:5:6:7:8  ::2:3:4:5:6:7:8  ::8             ::1.2.3.4\n)(?:%[0-9a-zA-Z]{1,})?                                             // %eth0            %1\n`.replace(/\s*\/\/.*$/gm,"").replace(/\n/g,"").trim(),q=new RegExp(`(?:^${F}$)|(?:^${T}$)`),H=new RegExp(`^${F}$`),R=new RegExp(`^${T}$`),I=e=>e&&e.exact?q:new RegExp(`(?:${D(e)}${F}${D(e)})|(?:${D(e)}${T}${D(e)})`,"g");I.v4=e=>e&&e.exact?H:new RegExp(`${D(e)}${F}${D(e)}`,"g"),I.v6=e=>e&&e.exact?R:new RegExp(`${D(e)}${T}${D(e)}`,"g");var K=I;const G=e=>K({exact:!0}).test(e);G.v4=e=>K.v4({exact:!0}).test(e),G.v6=e=>K.v6({exact:!0}).test(e),G.version=e=>G(e)?G.v4(e)?4:6:void 0;var M=G;function Y(e,t){if(void 0===t&&(t=e,e=0),"number"!=typeof e||"number"!=typeof t)throw new TypeError("Expected all arguments to be numbers");return Math.floor(Math.random()*(t-e+1)+e)}function U(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function B(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function X(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?B(Object(r),!0).forEach((function(t){U(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):B(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}var Z=P("trused-cert"),z=v.default.join.bind(v.default,Z),J=function(e,t){return i.execFileSync("openssl",e,X(X({},t),{},{stdio:"pipe",env:Object.assign({RANDFILE:v.default.join(z(".rnd"))},process.env)}))},Q=function(e,t){return t.every((function(t){return e.find((function(e){return e.includes("*")?new RegExp(e.replace("*","^[^.]+")+"$").test(t):e===t}))}))},V=function(e,t){return t.filter((function(t){return null==e.find((function(e){return e.includes("*")?new RegExp(e.replace("*","^[^.]+")+"$").test(t):e===t}))}))},W=h.default("trusted-cert:platform:darwin"),ee=function(){var e=b(S.mark((function e(t){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,new Promise((function(e){try{W('sudo security delete-certificate -c "'.concat(t,'"')),i.execSync('sudo security delete-certificate -c "'.concat(t,'"')),e(!0)}catch(t){e(!1)}}));case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),te=h.default("trusted-cert:platform:win32"),re=function(){var e=b(S.mark((function e(t){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,new Promise((function(e,r){try{i.execSync('certutil -delstore -user root "'.concat(t,'"')),e(!0)}catch(t){e(!1)}}));case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),ne="darwin"===process.platform,oe="win32"===process.platform,ae=ne?function(e){W("添加证书%o到系统钥匙串",e),i.execSync("sudo security add-trusted-cert         -d -r trustRoot         -k /Library/Keychains/System.keychain         '".concat(e,"'"))}:oe?function(e){i.exec("certutil -addstore -user root ".concat(e))}:function(e){i.execSync("sudo cp ".concat(e," /usr/local/share/ca-certificates/devcert.crt")),i.execSync("sudo update-ca-certificates")},ie=ne?function(e){var t;W("查询钥匙串里名称是%o的证书",e);try{t=i.execSync("security find-certificate -a -c '".concat(e,"' -Z | grep ^SHA-1"),{encoding:"utf-8"}).replace(/SHA-1\shash:\s/g,"").split("\n").filter((function(e){return e}))}catch(e){t=[]}return W("查询到的sha1 %o",t),t}:oe?function(e){var t;try{t=i.execSync('certutil -verifystore -user root "'.concat(e,'" | findstr sha1'),{encoding:"utf8"}).split("\n").map((function(e){return e.replace(/.*\(sha1\):\s/,"").replace(/[\s\r]/g,"").toUpperCase()})).filter(Boolean)}catch(e){te("获取钥匙串里证书失败%o",e),t=[]}return t}:function(){return[]},se=ne?ee:oe?re:function(){},ce=x.default.pki,ue=d.promisify(ce.rsa.generateKeyPair.bind(ce.rsa)),le="win32"===process.platform;function de(e){return fe.apply(this,arguments)}function fe(){return(fe=b(S.mark((function e(t){var r,n,o,a,i,s,c,u;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=[{name:"commonName",value:me}],n=1,o=t.filter((function(e){return!M(e)||M(e)&&"127.0.0.1"!==e&&++n<=5})),a=[{name:"basicConstraints",cA:!0,critical:!0},{name:"keyUsage",digitalSignature:!0,keyEncipherment:!0,nonRepudiation:!0},{name:"extKeyUsage",serverAuth:!0,clientAuth:!0},{name:"subjectAltName",altNames:o.map((function(e){var t=2,r=7;return M(e)?{type:r,ip:e}:{type:t,value:e}}))}],i=Y(5e4,99999).toString(),e.next=7,ue({bits:2048,workers:4});case 7:return s=e.sent,(c=ce.createCertificate()).publicKey=s.publicKey,c.serialNumber=Buffer.from(i).toString("hex"),c.validity.notBefore=new Date,c.validity.notAfter=new Date,c.validity.notAfter.setDate(c.validity.notAfter.getDate()+365),c.setSubject(r),c.setIssuer(r),c.setExtensions(a),u=s.privateKey,c.sign(u,x.default.md.sha256.create()),e.next=21,g.default.ensureDir(he);case 21:p.default.writeFileSync(ye,ce.privateKeyToPem(s.privateKey)),p.default.writeFileSync(ge,ce.certificateToPem(c));case 23:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var pe=h.default("trusted-cert:lib"),_e=A(),he=_e.sslCertificateDir,ve=_e.sslConfigFile,ye=_e.sslKeyPath,ge=_e.sslCrtPath,me=_e.CN,xe=function(e){var t=e.domains,r=e.ips;p.default.writeFileSync(ve,"\n[req] \nprompt = no \ndefault_bits = 4096\ndefault_md = sha256\ndistinguished_name = dn \nx509_extensions = v3_req\n\n[dn] \nCN=".concat(me,"\n\n[v3_req]\nbasicConstraints=critical, CA:TRUE\nkeyUsage=nonRepudiation, digitalSignature, keyEncipherment\nextendedKeyUsage=serverAuth,clientAuth\nsubjectAltName=@alt_names\n\n[alt_names]\n").concat(t.map((function(e,t){return"DNS.".concat(t+1," = ").concat(e)})).join("\n"),"\n").concat(r.map((function(e,t){return"IP.".concat(t+1," = ").concat(e)})).join("\n"),"\n").trim())},we=function(){var e=b(S.mark((function e(t){var r,n;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.filter((function(e){return!M(e)})),n=t.filter((function(e){return M(e)&&"127.0.0.1"!==e})).slice(-4),e.next=4,g.default.ensureDir(he);case 4:xe({domains:r,ips:["127.0.0.1"].concat(n)}),pe("成功创建证书配置文件");case 6:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),be=function(){var e=b(S.mark((function e(){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,new Promise((function(e,t){try{J(["req","-new","-newkey","rsa:2048","-sha1","-days","3650","-nodes","-x509","-keyout",ye,"-out",ge,"-config",ve]),pe("成功创建密钥和证书文件"),e()}catch(e){t(e)}}));case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),ke=function(){var e=b(S.mark((function e(t){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,de(t);case 2:pe("成功创建密钥和证书文件");case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),Se=function(){if("true"!==process.env.NO_OPENSSL&&r.sync("openssl"))return le?i.execSync("openssl x509 -in ".concat(ge," -noout -text | findstr DNS"),{encoding:"utf-8"}).trim().split(",").filter((function(e){return e.includes("DNS:")||e.includes("IP Address:")})).map((function(e){return e.trim().replace(/DNS:/,"").replace("IP Address:","")})):i.execSync("openssl x509 -in '".concat(ge,"' -noout -text | grep DNS"),{encoding:"utf-8"}).trim().split(",").filter((function(e){return e.includes("DNS:")||e.includes("IP Address:")})).map((function(e){return e.trim().replace(/DNS:/,"").replace("IP Address:","")}));var e=x.default.pki.certificateFromPem(p.default.readFileSync(ge,"utf8")),t=[],n=[],o=e.getExtension("subjectAltName");return void 0!==o&&o.altNames.forEach((function(e){2===e.type?t.push(e.value):7===e.type&&n.push(e.ip)})),t.concat(n)},Pe=function(){if("true"!==process.env.NO_OPENSSL&&r.sync("openssl"))return J(["x509","-in",ge,"-noout","-dates"],{encoding:"utf-8"}).trim().split("\n").map((function(e){return m.default(new Date(e.replace(/\w+=/,""))).format("YYYY-MM-DD HH:mm:ss")})).join(" ~ ");var e=x.default.pki.certificateFromPem(p.default.readFileSync(ge,"utf8"));return[e.validity.notBefore,e.validity.notAfter].map((function(e){return m.default(e).format("YYYY-MM-DD HH:mm:ss")})).join(" ~ ")},Ee=function(){var e=ie(me),t=$e();pe("已经添加信任的证书sha1".concat(e.join(","))),pe("证书文件的sha1".concat(t));var r=!1;return e.includes(t)&&(r=!0),r},$e=function(){if("true"!==process.env.NO_OPENSSL&&r.sync("openssl"))return J(["x509","-sha1","-in",ge,"-noout","-fingerprint"],{encoding:"utf-8"}).split("=")[1].replace(/:/g,"").trim();var e=x.default.pki.certificateFromPem(p.default.readFileSync(ge,"utf8")),t=x.default.asn1.toDer(x.default.pki.certificateToAsn1(e)).getBytes(),n=x.default.md.sha1.create();return n.start(),n.update(t),n.digest().toHex().match(/.{2}/g).join(":").toUpperCase().replace(/:/g,"").trim()},Oe=function(){return p.default.existsSync(ye)&&p.default.existsSync(ge)},je=function(){var e=b(S.mark((function e(t){return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,new Promise((function(e,r){try{c.sync(t),e()}catch(o){var n;if(!0===(null==o||null===(n=o.stderr)||void 0===n?void 0:n.includes("Permission denied")))try{i.execSync("sudo rm -rf ".concat(t)),e()}catch(e){r(e)}else r(o)}}));case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),Le={host_add_no_input:"输入要支持的host",host_add_no_install:"还没有安装自签名证书，运行下面命令安装使用",host_add_no_install_operation_tip:"$ trusted-cert install",host_add_has_supported_no_needed_added:"证书已经支持该域名，无须添加了",host_add_need_rebuild_and_trusted:"新增域名需要更新证书并重新信任",host_add_being_upgrading:"正在更新证书",host_add_failure:"新增域名失败",host_add_success:"更新成功",host_add_success_support_hosts:"更新后支持的域名",host_add_cert_valid_period:"更新后证书的起止有效时间：",host_add_trusted_suggestion:"请运行 trusted-cert trust 信任证书",info_ssl_key_path:"密钥文件路径：",info_ssl_cert_path:"证书文件路径：",info_ssl_cert_support_hosts:"支持的域名：",info_ssl_cert_valid_period:"有效时间：",info_ssl_cert_trusted_desc:"自签名证书已经添加到钥匙串并被始终信任",info_keychains_cert_name:"在钥匙串里的名称：",info_keychains_cert_sha1:"sha-1：",info_ssl_cert_not_trusted:"自签名证书还没被添加到钥匙串，可以运行下面命令，执行添加和始终信任",info_ssl_cert_trusted_cli_tip:"$ trusted-cert trust",info_extra_help:["","查看其它命令","$ trusted-cert --help","","配置webpack的HTTPS证书示例","https://github.com/sprying/trusted-cert#webpack","配置nginx的HTTPS证书示例","https://github.com/sprying/trusted-cert#nginx","配置nodejs的HTTPS证书示例","https://github.com/sprying/trusted-cert#nodejs","如有疑问联系@慧知"],add_trust_repeat_add_tip:"钥匙串里已经添加过，无须重复添加",add_trust_keychain_cert_info:"在钥匙串里证书的信息：",add_trust_keychain_cert_name:"名称: ",add_trust_keychain_cert_sha1:"sha-1：",add_trust_keychain_cert_success:"添加并信任成功，钥匙串里名称是：",add_trust_failure:"添加失败",add_trust_only_support_osx:"目前仅支持OSX系统",api_add_hosts_update_and_trust:"新增域名需要更新证书并重新信任",api_add_hosts_update_cert:"新增域名需要更新证书",api_add_hosts_rm_keychain_failure:"卸载老的证书失败，请授权重试",api_add_hosts_update_default:"自签名证书要新增支持的域名，正在更新自签名证书",api_add_hosts_remove_cert_dir_failure:"删除存放原证书的目录失败，请授权重试",install_has_installed_delete_tip:"继续操作会覆盖该工具已创建的证书",install_del_installed_process_creating:"正在创建证书...",install_inquirer_domains_with_default:"输入启动本地HTTPS服务时使用的域名，多个以,分隔，直接回车将使用默认",install_inquirer_domains:"输入启动本地HTTPS服务时使用的域名，多个以,分隔，如abc.com,*.abc.com",install_create_key_cert_file_success:"成功创建密钥和自签名证书文件",install_create_key_cert_file_failure:"创建密钥和自签名证书文件失败",install_add_keychain_process_tip:"向系统的钥匙串里添加证书并始终信任...",install_add_keychain_success:"添加并信任成功，钥匙串里名称为：",install_add_keychain_failure:"钥匙串添加证书失败",install_over:"安装结束",install_over_extra_info:["","可随时通过下面命令查看自签名证书信息","$ trusted-cert","","安装证书的结果："],uninstall_unfound:"还没有安装过证书",uninstall_del_keychain:"正在删除钥匙串里名称「%s」的证书",uninstall_del_keychain_success:"删除成功",uninstall_del_keychain_failure:"删除失败，流程结束",uninstall_rm_dir_success:"已经删除存放密钥和证书的目录%s",uninstall_rm_dir_failure:"删除存放原证书的目录失败，流程结束",uninstall_complete:"删除完成"},Ne=h.default("trusted-cert"),Ae=A(),De=Ae.sslCertificateDir,Fe=Ae.sslKeyPath,Ce=Ae.sslCrtPath,Te=Ae.CN,qe=Ae.defaultDomains,He=Le,Re=function(){var e,t;return!!Oe()||(console.warn(null!==(e=He.host_add_no_install)&&void 0!==e?e:"还没有安装自签名证书，运行下面命令安装使用"),console.warn(null!==(t=He.host_add_no_install_operation_tip)&&void 0!==t?t:"$ trusted-cert install"),!1)},Ie=function(){var e=b(S.mark((function e(){var t,r,n,o;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=[{type:"input",name:"domains",message:qe.length>0?He.install_inquirer_domains_with_default:He.install_inquirer_domains,default:qe.join(",")}],e.next=3,_.default.prompt(t);case 3:if(r=e.sent,""===(n=r.domains)){e.next=9;break}o=n.split(",").map((function(e){return e.trim()})).filter(Boolean),e.next=10;break;case 9:return e.abrupt("return",[]);case 10:return o=o.reduce((function(e,t){return!e.includes(t)&&e.push(t),e}),[]),e.abrupt("return",o);case 12:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),Ke=function(){var e=b(S.mark((function e(){var t,n,o,a,i,s,c,u,l,d,f,h,v;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(o=ie(Te),a=p.default.existsSync(De),0===o.length&&!a){e.next=17;break}return c=null!==(i=He.install_has_installed_delete_tip)&&void 0!==i?i:"继续操作会覆盖该工具已创建的证书",e.next=6,_.default.prompt([{type:"confirm",name:"continue",message:c,default:!1}]);case 6:if(u=e.sent,e.t0=u.continue,!e.t0){e.next=12;break}return e.next=11,Ge();case 11:e.t0=e.sent;case 12:if(e.t0){e.next=14;break}return e.abrupt("return",!1);case 14:if(u.continue){e.next=16;break}return e.abrupt("return",!1);case 16:console.log(null!==(s=He.install_del_installed_process_creating)&&void 0!==s?s:"正在创建证书...");case 17:return e.next=19,Ie();case 19:if(l=e.sent,e.prev=20,"true"!==process.env.NO_OPENSSL&&r.sync("openssl")){e.next=26;break}return e.next=24,ke(l);case 24:e.next=30;break;case 26:return e.next=28,we(l);case 28:return e.next=30,be();case 30:console.log(null!==(d=He.install_create_key_cert_file_success)&&void 0!==d?d:"成功创建密钥和自签名证书文件"),e.next=36;break;case 33:e.prev=33,e.t1=e.catch(20),console.log(null!==(f=He.install_create_key_cert_file_failure)&&void 0!==f?f:"创建密钥和自签名证书文件失败");case 36:console.log(null!==(t=He.install_add_keychain_process_tip)&&void 0!==t?t:"向系统的钥匙串里添加证书并始终信任...");try{ae(Ce),console.log(null!==(h=He.install_add_keychain_success)&&void 0!==h?h:"添加并信任成功，钥匙串里名称为：",Te)}catch(e){console.warn(null!==(v=He.install_add_keychain_failure)&&void 0!==v?v:"钥匙串添加证书失败")}return console.log(null!==(n=He.install_over)&&void 0!==n?n:"安装结束"),He.install_over_extra_info.forEach((function(e){console.log(e)})),e.abrupt("return",Be());case 41:case"end":return e.stop()}}),e,null,[[20,33]])})));return function(){return e.apply(this,arguments)}}(),Ge=function(){var e=b(S.mark((function e(){var t,r,n,o,a,i,s,c,u;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=ie(Te),n=p.default.existsSync(De),0!==r.length||n){e.next=5;break}return console.warn(null!==(o=He.uninstall_unfound)&&void 0!==o?o:"没有找到该工具安装的证书"),e.abrupt("return",!0);case 5:if(!(r.length>0)){e.next=17;break}return console.log(null!==(a=He.uninstall_del_keychain)&&void 0!==a?a:"正在删除钥匙串里名称「%s」的证书",Te),e.prev=7,e.next=10,se(Te);case 10:console.log(null!==(i=He.uninstall_del_keychain_success)&&void 0!==i?i:"删除成功"),e.next=17;break;case 13:return e.prev=13,e.t0=e.catch(7),console.error(null!==(s=He.uninstall_del_keychain_failure)&&void 0!==s?s:"删除失败，流程结束"),e.abrupt("return",!1);case 17:if(!n){e.next=28;break}return e.prev=18,e.next=21,je(De);case 21:console.log(null!==(c=He.uninstall_rm_dir_success)&&void 0!==c?c:"已经删除存放密钥和证书的目录%s",De),e.next=28;break;case 24:return e.prev=24,e.t1=e.catch(18),console.log(null!==(u=He.uninstall_rm_dir_failure)&&void 0!==u?u:"删除存放原证书的目录失败，流程结束"),e.abrupt("return",!1);case 28:return console.log(null!==(t=He.uninstall_complete)&&void 0!==t?t:"删除完成"),e.abrupt("return",!0);case 30:case"end":return e.stop()}}),e,null,[[7,13],[18,24]])})));return function(){return e.apply(this,arguments)}}(),Me=function(){var e=b(S.mark((function e(){var t,r,n,o,a,i,s,c;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(Re()){e.next=2;break}return e.abrupt("return",!1);case 2:if(t=ie(Te),Ne("已添加到钥匙串sha1列表 %o",t),r=$e(),Ne("要新增的sha1是 %o",r),!t.includes(r)){e.next=14;break}return console.log(null!==(n=He.add_trust_repeat_add_tip)&&void 0!==n?n:"钥匙串里已经添加过，无须重复添加"),console.log(null!==(o=He.add_trust_keychain_cert_info)&&void 0!==o?o:"在钥匙串里证书的信息："),console.log(null!==(a=He.add_trust_keychain_cert_name)&&void 0!==a?a:"名称: ",Te),console.log(null!==(i=He.add_trust_keychain_cert_sha1)&&void 0!==i?i:"sha-1: ",r),e.abrupt("return",!0);case 14:e.prev=14,ae(Ce),console.log(null!==(s=He.add_trust_keychain_cert_success)&&void 0!==s?s:"添加并信任成功，钥匙串里名称是：",Te),e.next=23;break;case 19:return e.prev=19,e.t0=e.catch(14),console.error(null!==(c=He.add_trust_failure)&&void 0!==c?c:"添加失败"),e.abrupt("return",!1);case 23:return e.abrupt("return",!0);case 24:case"end":return e.stop()}}),e,null,[[14,19]])})));return function(){return e.apply(this,arguments)}}(),Ye=function(){var e=b(S.mark((function e(){var t,r,n,o,a,i,s,c,u,l,d,f,p,_,h,v,y=arguments;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(0!==(t=y.length>0&&void 0!==y[0]?y[0]:[]).length){e.next=4;break}return console.warn(null!==(r=He.host_add_no_input)&&void 0!==r?r:"输入要支持的host"),e.abrupt("return",!1);case 4:if(Re()){e.next=6;break}return e.abrupt("return",!1);case 6:if(n=Se(),!Q(n,t)){e.next=11;break}return console.warn(null!==(o=He.host_add_has_supported_no_needed_added)&&void 0!==o?o:"证书已经支持该域名，无须添加了"),e.abrupt("return",!0);case 11:return a=V(n,t),i=n.concat(a),(s=ie(Te)).length>0?console.log(null!==(c=He.host_add_need_rebuild_and_trusted)&&void 0!==c?c:"新增域名需要更新证书并重新信任"):console.log(null!==(u=He.host_add_being_upgrading)&&void 0!==u?u:"正在更新证书"),e.prev=15,e.next=18,se(Te);case 18:e.next=24;break;case 20:return e.prev=20,e.t0=e.catch(15),console.error(null!==(l=He.host_add_failure)&&void 0!==l?l:"新增域名失败"),e.abrupt("return",!1);case 24:return e.prev=24,e.next=27,je(De);case 27:return e.next=29,we(i);case 29:return e.next=31,be();case 31:return s.length>0&&ae(Ce),console.log(null!==(d=He.host_add_success)&&void 0!==d?d:"更新成功"),console.log(null!==(f=He.host_add_success_support_hosts)&&void 0!==f?f:"更新后支持的域名列表"),_=Se(),console.log(_.join(",")),console.log(null!==(p=He.host_add_cert_valid_period)&&void 0!==p?p:"更新后证书的起止有效时间："),console.log(Pe()),0===s.length&&console.warn(null!==(h=He.host_add_trusted_suggestion)&&void 0!==h?h:"请运行 trusted-cert trust 信任证书"),e.abrupt("return",!0);case 42:return e.prev=42,e.t1=e.catch(24),console.error(null!==(v=He.host_add_failure)&&void 0!==v?v:"新增域名失败"),e.abrupt("return",!1);case 46:case"end":return e.stop()}}),e,null,[[15,20],[24,42]])})));return function(){return e.apply(this,arguments)}}();function Ue(){return(Ue=b(S.mark((function e(t,n){var o,a,i,s,c,u,l,d,f,_,h,v;return S.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(o=!1,Array.isArray(t)||"string"==typeof t?o=null!==(s=null==n?void 0:n.silent)&&void 0!==s&&s:(o=null!==(a=null===(i=t)||void 0===i?void 0:i.silent)&&void 0!==a&&a,t=qe),"string"==typeof t&&(t=[t]),!(c=Oe())||!Q(Se(),t)){e.next=8;break}Ne("之前已经添加过域名，跳过返回之前的域名");try{Ee()||(console.log("创建自签名证书"),ae(Ce)),u=!0}catch(e){u=!1}return e.abrupt("return",{key:p.default.readFileSync(Fe),cert:p.default.readFileSync(Ce),keyFilePath:Fe,certFilePath:Ce,trusted:u});case 8:if(console.log("创建自签名证书"),!c){e.next=30;break}return l=Se(),ie(Te).length>0?!o&&console.log(null!==(d=He.api_add_hosts_update_and_trust)&&void 0!==d?d:"新增域名需要更新证书并重新信任"):!o&&console.log(null!==(f=He.api_add_hosts_update_cert)&&void 0!==f?f:"新增域名需要更新证书"),e.prev=13,e.next=16,se(Te);case 16:e.next=21;break;case 18:throw e.prev=18,e.t0=e.catch(13),new Error(null!==(_=He.api_add_hosts_rm_keychain_failure)&&void 0!==_?_:"卸载老的证书失败，请授权重试");case 21:return e.prev=21,e.next=24,je(De);case 24:e.next=29;break;case 26:throw e.prev=26,e.t1=e.catch(21),new Error(null!==(h=He.api_add_hosts_remove_cert_dir_failure)&&void 0!==h?h:"删除存放原证书的目录失败，请授权重试");case 29:t=l.concat(V(l,t));case 30:if("true"!==process.env.NO_OPENSSL&&r.sync("openssl")){e.next=35;break}return e.next=33,ke(t);case 33:e.next=39;break;case 35:return e.next=37,we(t);case 37:return e.next=39,be();case 39:try{Ee()||ae(Ce),v=!0}catch(e){v=!1}return e.abrupt("return",{key:p.default.readFileSync(Fe),cert:p.default.readFileSync(Ce),keyFilePath:Fe,certFilePath:Ce,trusted:v});case 41:case"end":return e.stop()}}),e,null,[[13,18],[21,26]])})))).apply(this,arguments)}var Be=function(){var e,t,r,n;if(!Re())return!1;var o=Se();console.log(null!==(e=He.info_ssl_key_path)&&void 0!==e?e:"密钥文件路径：",Fe),console.log(null!==(t=He.info_ssl_cert_path)&&void 0!==t?t:"自签名证书文件路径：",Ce),console.log(null!==(r=He.info_ssl_cert_support_hosts)&&void 0!==r?r:"自签名证书已经支持的域名：",o.join(",")),console.log(null!==(n=He.info_ssl_cert_valid_period)&&void 0!==n?n:"自签名证书的有效时间：",Pe());var a,i,s,c,u,l=ie(Te),d=$e();l.includes(d)?(console.log(null!==(a=He.info_ssl_cert_trusted_desc)&&void 0!==a?a:"自签名证书已经添加到钥匙串并被始终信任"),console.log(null!==(i=He.info_keychains_cert_name)&&void 0!==i?i:"自签名证书在钥匙串里的名称：",Te,", ",null!==(s=He.info_keychains_cert_sha1)&&void 0!==s?s:"自签名证书在钥匙串里的sha-1：",d)):(console.log(null!==(c=He.info_ssl_cert_not_trusted)&&void 0!==c?c:"自签名证书还没被添加到钥匙串，可以运行下面命令，执行添加和始终信任"),console.log(null!==(u=He.info_ssl_cert_trusted_cli_tip)&&void 0!==u?u:"$ trusted-cert trust"));return He.info_extra_help.forEach((function(e){console.log(e)})),!0};exports.addHosts=Ye,exports.certificateFor=function(e,t){return Ue.apply(this,arguments)},exports.doTrust=Me,exports.info=Be,exports.install=Ke,exports.mergeLan=function(e){return Object.assign(Le,e),Le},exports.setConfig=function(e){E&&(E=e.sslCertificateDir),$&&($=e.sslConfigFile),O&&(O=e.sslKeyPath),j&&(j=e.sslCrtPath),L&&(L=e.name),N&&(N=e.defaultDomains)},exports.uninstall=Ge;
