/*!
 * trusted-cert.js v1.1.3
 * (c) 2020-2021 [object Object]
 * Released under the MIT License.
 */
import t from"fs";import e from"inquirer";import{sync as r}from"command-exists";import n from"debug";import o from"path";import i from"os";import{execFileSync as a,execSync as s,exec as c}from"child_process";import u from"fs-extra";import{sync as l}from"rimraf";import d from"moment";import f from"node-forge";import{promisify as p}from"util";function _(t,e,r,n,o,i,a){try{var s=t[i](a),c=s.value}catch(t){return void r(t)}s.done?e(c):Promise.resolve(c).then(n,o)}function h(t){return function(){var e=this,r=arguments;return new Promise((function(n,o){var i=t.apply(e,r);function a(t){_(i,n,o,a,s,"next",t)}function s(t){_(i,n,o,a,s,"throw",t)}a(void 0)}))}}var v,y=(function(t){var e=function(t){var e,r=Object.prototype,n=r.hasOwnProperty,o="function"==typeof Symbol?Symbol:{},i=o.iterator||"@@iterator",a=o.asyncIterator||"@@asyncIterator",s=o.toStringTag||"@@toStringTag";function c(t,e,r){return Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{c({},"")}catch(t){c=function(t,e,r){return t[e]=r}}function u(t,e,r,n){var o=e&&e.prototype instanceof v?e:v,i=Object.create(o.prototype),a=new O(n||[]);return i._invoke=function(t,e,r){var n=d;return function(o,i){if(n===p)throw new Error("Generator is already running");if(n===_){if("throw"===o)throw i;return L()}for(r.method=o,r.arg=i;;){var a=r.delegate;if(a){var s=E(a,r);if(s){if(s===h)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(n===d)throw n=_,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n=p;var c=l(t,e,r);if("normal"===c.type){if(n=r.done?_:f,c.arg===h)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n=_,r.method="throw",r.arg=c.arg)}}}(t,r,a),i}function l(t,e,r){try{return{type:"normal",arg:t.call(e,r)}}catch(t){return{type:"throw",arg:t}}}t.wrap=u;var d="suspendedStart",f="suspendedYield",p="executing",_="completed",h={};function v(){}function y(){}function m(){}var g={};g[i]=function(){return this};var x=Object.getPrototypeOf,w=x&&x(x(j([])));w&&w!==r&&n.call(w,i)&&(g=w);var b=m.prototype=v.prototype=Object.create(g);function k(t){["next","throw","return"].forEach((function(e){c(t,e,(function(t){return this._invoke(e,t)}))}))}function P(t,e){function r(o,i,a,s){var c=l(t[o],t,i);if("throw"!==c.type){var u=c.arg,d=u.value;return d&&"object"==typeof d&&n.call(d,"__await")?e.resolve(d.__await).then((function(t){r("next",t,a,s)}),(function(t){r("throw",t,a,s)})):e.resolve(d).then((function(t){u.value=t,a(u)}),(function(t){return r("throw",t,a,s)}))}s(c.arg)}var o;this._invoke=function(t,n){function i(){return new e((function(e,o){r(t,n,e,o)}))}return o=o?o.then(i,i):i()}}function E(t,r){var n=t.iterator[r.method];if(n===e){if(r.delegate=null,"throw"===r.method){if(t.iterator.return&&(r.method="return",r.arg=e,E(t,r),"throw"===r.method))return h;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return h}var o=l(n,t.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,h;var i=o.arg;return i?i.done?(r[t.resultName]=i.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=e),r.delegate=null,h):i:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,h)}function $(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function S(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function O(t){this.tryEntries=[{tryLoc:"root"}],t.forEach($,this),this.reset(!0)}function j(t){if(t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,a=function r(){for(;++o<t.length;)if(n.call(t,o))return r.value=t[o],r.done=!1,r;return r.value=e,r.done=!0,r};return a.next=a}}return{next:L}}function L(){return{value:e,done:!0}}return y.prototype=b.constructor=m,m.constructor=y,y.displayName=c(m,s,"GeneratorFunction"),t.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===y||"GeneratorFunction"===(e.displayName||e.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,m):(t.__proto__=m,c(t,s,"GeneratorFunction")),t.prototype=Object.create(b),t},t.awrap=function(t){return{__await:t}},k(P.prototype),P.prototype[a]=function(){return this},t.AsyncIterator=P,t.async=function(e,r,n,o,i){void 0===i&&(i=Promise);var a=new P(u(e,r,n,o),i);return t.isGeneratorFunction(r)?a:a.next().then((function(t){return t.done?t.value:a.next()}))},k(b),c(b,s,"Generator"),b[i]=function(){return this},b.toString=function(){return"[object Generator]"},t.keys=function(t){var e=[];for(var r in t)e.push(r);return e.reverse(),function r(){for(;e.length;){var n=e.pop();if(n in t)return r.value=n,r.done=!1,r}return r.done=!0,r}},t.values=j,O.prototype={constructor:O,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(S),!t)for(var r in this)"t"===r.charAt(0)&&n.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=e)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var r=this;function o(n,o){return s.type="throw",s.arg=t,r.next=n,o&&(r.method="next",r.arg=e),!!o}for(var i=this.tryEntries.length-1;i>=0;--i){var a=this.tryEntries[i],s=a.completion;if("root"===a.tryLoc)return o("end");if(a.tryLoc<=this.prev){var c=n.call(a,"catchLoc"),u=n.call(a,"finallyLoc");if(c&&u){if(this.prev<a.catchLoc)return o(a.catchLoc,!0);if(this.prev<a.finallyLoc)return o(a.finallyLoc)}else if(c){if(this.prev<a.catchLoc)return o(a.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return o(a.finallyLoc)}}}},abrupt:function(t,e){for(var r=this.tryEntries.length-1;r>=0;--r){var o=this.tryEntries[r];if(o.tryLoc<=this.prev&&n.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var i=o;break}}i&&("break"===t||"continue"===t)&&i.tryLoc<=e&&e<=i.finallyLoc&&(i=null);var a=i?i.completion:{};return a.type=t,a.arg=e,i?(this.method="next",this.next=i.finallyLoc,h):this.complete(a)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),h},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.finallyLoc===t)return this.complete(r.completion,r.afterLoc),S(r),h}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.tryLoc===t){var n=r.completion;if("throw"===n.type){var o=n.arg;S(r)}return o}}throw new Error("illegal catch attempt")},delegateYield:function(t,r,n){return this.delegate={iterator:j(t),resultName:r,nextLoc:n},"next"===this.method&&(this.arg=e),h}},t}(t.exports);try{regeneratorRuntime=e}catch(t){Function("r","regeneratorRuntime = r")(e)}}(v={exports:{}},v.exports),v.exports);function m(t){if("string"!=typeof t)throw new TypeError("`name` must be string");switch(i.platform()){case"darwin":return o.join(process.env.HOME,".trusted-cert");case"linux":return function(t){return null!=process.env.XDG_CONFIG_HOME?o.join(process.env.XDG_CONFIG_HOME,t):o.join(process.env.HOME,".config",t)}(t);case"win32":return function(t){return null!=process.env.LOCALAPPDATA?o.join(process.env.LOCALAPPDATA,t):o.join(process.env.USERPROFILE,"Local Settings","Application Data",t)}(t)}throw new Error("Platform not supported")}var g=m("trusted-cert"),x=o.join(g,"./ssl.cnf"),w=o.join(g,"./ssl.key"),b=o.join(g,"./ssl.crt"),k="generated by trusted-cert",P=["localhost"],E=function(t){g&&(g=t.sslCertificateDir),x&&(x=t.sslConfigFile),w&&(w=t.sslKeyPath),b&&(b=t.sslCrtPath),k&&(k=t.name),P&&(P=t.defaultDomains)},$=function(){return{sslCertificateDir:g,sslConfigFile:x,sslKeyPath:w,sslCrtPath:b,CN:k,defaultDomains:P}};const S=t=>t&&t.includeBoundaries?"(?:(?<=\\s|^)(?=[a-fA-F\\d:])|(?<=[a-fA-F\\d:])(?=\\s|$))":"",O="(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)(?:\\.(?:25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]\\d|\\d)){3}",j="[a-fA-F\\d]{1,4}",L=`\n(?:\n(?:${j}:){7}(?:${j}|:)|                                    // 1:2:3:4:5:6:7::  1:2:3:4:5:6:7:8\n(?:${j}:){6}(?:${O}|:${j}|:)|                             // 1:2:3:4:5:6::    1:2:3:4:5:6::8   1:2:3:4:5:6::8  1:2:3:4:5:6::1.2.3.4\n(?:${j}:){5}(?::${O}|(?::${j}){1,2}|:)|                   // 1:2:3:4:5::      1:2:3:4:5::7:8   1:2:3:4:5::8    1:2:3:4:5::7:1.2.3.4\n(?:${j}:){4}(?:(?::${j}){0,1}:${O}|(?::${j}){1,3}|:)| // 1:2:3:4::        1:2:3:4::6:7:8   1:2:3:4::8      1:2:3:4::6:7:1.2.3.4\n(?:${j}:){3}(?:(?::${j}){0,2}:${O}|(?::${j}){1,4}|:)| // 1:2:3::          1:2:3::5:6:7:8   1:2:3::8        1:2:3::5:6:7:1.2.3.4\n(?:${j}:){2}(?:(?::${j}){0,3}:${O}|(?::${j}){1,5}|:)| // 1:2::            1:2::4:5:6:7:8   1:2::8          1:2::4:5:6:7:1.2.3.4\n(?:${j}:){1}(?:(?::${j}){0,4}:${O}|(?::${j}){1,6}|:)| // 1::              1::3:4:5:6:7:8   1::8            1::3:4:5:6:7:1.2.3.4\n(?::(?:(?::${j}){0,5}:${O}|(?::${j}){1,7}|:))             // ::2:3:4:5:6:7:8  ::2:3:4:5:6:7:8  ::8             ::1.2.3.4\n)(?:%[0-9a-zA-Z]{1,})?                                             // %eth0            %1\n`.replace(/\s*\/\/.*$/gm,"").replace(/\n/g,"").trim(),N=new RegExp(`(?:^${O}$)|(?:^${L}$)`),A=new RegExp(`^${O}$`),D=new RegExp(`^${L}$`),F=t=>t&&t.exact?N:new RegExp(`(?:${S(t)}${O}${S(t)})|(?:${S(t)}${L}${S(t)})`,"g");F.v4=t=>t&&t.exact?A:new RegExp(`${S(t)}${O}${S(t)}`,"g"),F.v6=t=>t&&t.exact?D:new RegExp(`${S(t)}${L}${S(t)}`,"g");var C=F;const T=t=>C({exact:!0}).test(t);T.v4=t=>C.v4({exact:!0}).test(t),T.v6=t=>C.v6({exact:!0}).test(t),T.version=t=>T(t)?T.v4(t)?4:6:void 0;var R=T;function H(t,e){if(void 0===e&&(e=t,t=0),"number"!=typeof t||"number"!=typeof e)throw new TypeError("Expected all arguments to be numbers");return Math.floor(Math.random()*(e-t+1)+t)}function I(t,e,r){return e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}function K(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),r.push.apply(r,n)}return r}function G(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?K(Object(r),!0).forEach((function(e){I(t,e,r[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):K(Object(r)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))}))}return t}var M=m("trused-cert"),Y=o.join.bind(o,M),q=function(t,e){return a("openssl",t,G(G({},e),{},{stdio:"pipe",env:Object.assign({RANDFILE:o.join(Y(".rnd"))},process.env)}))},U=function(t,e){return e.every((function(e){return t.find((function(t){return t.includes("*")?new RegExp(t.replace("*","^[^.]+")+"$").test(e):t===e}))}))},B=function(t,e){return e.filter((function(e){return null==t.find((function(t){return t.includes("*")?new RegExp(t.replace("*","^[^.]+")+"$").test(e):t===e}))}))},X=n("trusted-cert:platform:darwin"),Z=function(){var t=h(y.mark((function t(e){return y.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,new Promise((function(t){try{X('sudo security delete-certificate -c "'.concat(e,'"')),s('sudo security delete-certificate -c "'.concat(e,'"')),t(!0)}catch(e){t(!1)}}));case 2:return t.abrupt("return",t.sent);case 3:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}(),z=n("trusted-cert:platform:win32"),J=function(){var t=h(y.mark((function t(e){return y.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,new Promise((function(t,r){try{s('certutil -delstore -user root "'.concat(e,'"')),t(!0)}catch(e){t(!1)}}));case 2:return t.abrupt("return",t.sent);case 3:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}(),Q="darwin"===process.platform,V="win32"===process.platform,W=Q?function(t){X("添加证书%o到系统钥匙串",t),s("sudo security add-trusted-cert         -d -r trustRoot         -k /Library/Keychains/System.keychain         '".concat(t,"'"))}:V?function(t){c("certutil -addstore -user root ".concat(t))}:function(t){s("sudo cp ".concat(t," /usr/local/share/ca-certificates/devcert.crt")),s("sudo update-ca-certificates")},tt=Q?function(t){var e;X("查询钥匙串里名称是%o的证书",t);try{e=s("security find-certificate -a -c '".concat(t,"' -Z | grep ^SHA-1"),{encoding:"utf-8"}).replace(/SHA-1\shash:\s/g,"").split("\n").filter((function(t){return t}))}catch(t){e=[]}return X("查询到的sha1 %o",e),e}:V?function(t){var e;try{e=s('certutil -verifystore -user root "'.concat(t,'" | findstr sha1'),{encoding:"utf8"}).split("\n").map((function(t){return t.replace(/.*\(sha1\):\s/,"").replace(/[\s\r]/g,"").toUpperCase()})).filter(Boolean)}catch(t){z("获取钥匙串里证书失败%o",t),e=[]}return e}:function(){return[]},et=Q?Z:V?J:function(){},rt=f.pki,nt=p(rt.rsa.generateKeyPair.bind(rt.rsa)),ot="win32"===process.platform;function it(t){return at.apply(this,arguments)}function at(){return(at=h(y.mark((function e(r){var n,o,i,a,s,c,l,d;return y.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=[{name:"commonName",value:pt}],o=1,i=r.filter((function(t){return!R(t)||R(t)&&"127.0.0.1"!==t&&++o<=5})),a=[{name:"basicConstraints",cA:!0,critical:!0},{name:"keyUsage",digitalSignature:!0,keyEncipherment:!0,nonRepudiation:!0},{name:"extKeyUsage",serverAuth:!0,clientAuth:!0},{name:"subjectAltName",altNames:i.map((function(t){var e=2,r=7;return R(t)?{type:r,ip:t}:{type:e,value:t}}))}],s=H(5e4,99999).toString(),e.next=7,nt({bits:2048,workers:4});case 7:return c=e.sent,(l=rt.createCertificate()).publicKey=c.publicKey,l.serialNumber=Buffer.from(s).toString("hex"),l.validity.notBefore=new Date,l.validity.notAfter=new Date,l.validity.notAfter.setDate(l.validity.notAfter.getDate()+365),l.setSubject(n),l.setIssuer(n),l.setExtensions(a),d=c.privateKey,l.sign(d,f.md.sha256.create()),e.next=21,u.ensureDir(ut);case 21:t.writeFileSync(dt,rt.privateKeyToPem(c.privateKey)),t.writeFileSync(ft,rt.certificateToPem(l));case 23:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var st=n("trusted-cert:lib"),ct=$(),ut=ct.sslCertificateDir,lt=ct.sslConfigFile,dt=ct.sslKeyPath,ft=ct.sslCrtPath,pt=ct.CN,_t=function(e){var r=e.domains,n=e.ips;t.writeFileSync(lt,"\n[req] \nprompt = no \ndefault_bits = 4096\ndefault_md = sha256\ndistinguished_name = dn \nx509_extensions = v3_req\n\n[dn] \nCN=".concat(pt,"\n\n[v3_req]\nbasicConstraints=critical, CA:TRUE\nkeyUsage=nonRepudiation, digitalSignature, keyEncipherment\nextendedKeyUsage=serverAuth,clientAuth\nsubjectAltName=@alt_names\n\n[alt_names]\n").concat(r.map((function(t,e){return"DNS.".concat(e+1," = ").concat(t)})).join("\n"),"\n").concat(n.map((function(t,e){return"IP.".concat(e+1," = ").concat(t)})).join("\n"),"\n").trim())},ht=function(){var t=h(y.mark((function t(e){var r,n;return y.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return r=e.filter((function(t){return!R(t)})),n=e.filter((function(t){return R(t)&&"127.0.0.1"!==t})).slice(-4),t.next=4,u.ensureDir(ut);case 4:_t({domains:r,ips:["127.0.0.1"].concat(n)}),st("成功创建证书配置文件");case 6:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}(),vt=function(){var t=h(y.mark((function t(){return y.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,new Promise((function(t,e){try{q(["req","-new","-newkey","rsa:2048","-sha1","-days","3650","-nodes","-x509","-keyout",dt,"-out",ft,"-config",lt]),st("成功创建密钥和证书文件"),t()}catch(t){e(t)}}));case 2:return t.abrupt("return",t.sent);case 3:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}(),yt=function(){var t=h(y.mark((function t(e){return y.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,it(e);case 2:st("成功创建密钥和证书文件");case 3:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}(),mt=function(){if("true"!==process.env.NO_OPENSSL&&r("openssl"))return ot?s("openssl x509 -in ".concat(ft," -noout -text | findstr DNS"),{encoding:"utf-8"}).trim().split(",").filter((function(t){return t.includes("DNS:")||t.includes("IP Address:")})).map((function(t){return t.trim().replace(/DNS:/,"").replace("IP Address:","")})):s("openssl x509 -in '".concat(ft,"' -noout -text | grep DNS"),{encoding:"utf-8"}).trim().split(",").filter((function(t){return t.includes("DNS:")||t.includes("IP Address:")})).map((function(t){return t.trim().replace(/DNS:/,"").replace("IP Address:","")}));var e=f.pki.certificateFromPem(t.readFileSync(ft,"utf8")),n=[],o=[],i=e.getExtension("subjectAltName");return void 0!==i&&i.altNames.forEach((function(t){2===t.type?n.push(t.value):7===t.type&&o.push(t.ip)})),n.concat(o)},gt=function(){if("true"!==process.env.NO_OPENSSL&&r("openssl"))return q(["x509","-in",ft,"-noout","-dates"],{encoding:"utf-8"}).trim().split("\n").map((function(t){return d(new Date(t.replace(/\w+=/,""))).format("YYYY-MM-DD HH:mm:ss")})).join(" ~ ");var e=f.pki.certificateFromPem(t.readFileSync(ft,"utf8"));return[e.validity.notBefore,e.validity.notAfter].map((function(t){return d(t).format("YYYY-MM-DD HH:mm:ss")})).join(" ~ ")},xt=function(){var t=tt(pt),e=wt();st("已经添加信任的证书sha1".concat(t.join(","))),st("证书文件的sha1".concat(e));var r=!1;return t.includes(e)&&(r=!0),r},wt=function(){if("true"!==process.env.NO_OPENSSL&&r("openssl"))return q(["x509","-sha1","-in",ft,"-noout","-fingerprint"],{encoding:"utf-8"}).split("=")[1].replace(/:/g,"").trim();var e=f.pki.certificateFromPem(t.readFileSync(ft,"utf8")),n=f.asn1.toDer(f.pki.certificateToAsn1(e)).getBytes(),o=f.md.sha1.create();return o.start(),o.update(n),o.digest().toHex().match(/.{2}/g).join(":").toUpperCase().replace(/:/g,"").trim()},bt=function(){return t.existsSync(dt)&&t.existsSync(ft)},kt=function(){var t=h(y.mark((function t(e){return y.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,new Promise((function(t,r){try{l(e),t()}catch(o){var n;if(!0===(null==o||null===(n=o.stderr)||void 0===n?void 0:n.includes("Permission denied")))try{s("sudo rm -rf ".concat(e)),t()}catch(t){r(t)}else r(o)}}));case 2:return t.abrupt("return",t.sent);case 3:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}(),Pt={host_add_no_input:"输入要支持的host",host_add_no_install:"还没有安装自签名证书，运行下面命令安装使用",host_add_no_install_operation_tip:"$ trusted-cert install",host_add_has_supported_no_needed_added:"证书已经支持该域名，无须添加了",host_add_need_rebuild_and_trusted:"新增域名需要更新证书并重新信任",host_add_being_upgrading:"正在更新证书",host_add_failure:"新增域名失败",host_add_success:"更新成功",host_add_success_support_hosts:"更新后支持的域名",host_add_cert_valid_period:"更新后证书的起止有效时间：",host_add_trusted_suggestion:"请运行 trusted-cert trust 信任证书",info_ssl_key_path:"密钥文件路径：",info_ssl_cert_path:"证书文件路径：",info_ssl_cert_support_hosts:"支持的域名：",info_ssl_cert_valid_period:"有效时间：",info_ssl_cert_trusted_desc:"自签名证书已经添加到钥匙串并被始终信任",info_keychains_cert_name:"在钥匙串里的名称：",info_keychains_cert_sha1:"sha-1：",info_ssl_cert_not_trusted:"自签名证书还没被添加到钥匙串，可以运行下面命令，执行添加和始终信任",info_ssl_cert_trusted_cli_tip:"$ trusted-cert trust",info_extra_help:["","查看其它命令","$ trusted-cert --help","","配置webpack的HTTPS证书示例","https://github.com/sprying/trusted-cert#webpack","配置nginx的HTTPS证书示例","https://github.com/sprying/trusted-cert#nginx","配置nodejs的HTTPS证书示例","https://github.com/sprying/trusted-cert#nodejs","如有疑问联系@慧知"],add_trust_repeat_add_tip:"钥匙串里已经添加过，无须重复添加",add_trust_keychain_cert_info:"在钥匙串里证书的信息：",add_trust_keychain_cert_name:"名称: ",add_trust_keychain_cert_sha1:"sha-1：",add_trust_keychain_cert_success:"添加并信任成功，钥匙串里名称是：",add_trust_failure:"添加失败",add_trust_only_support_osx:"目前仅支持OSX系统",api_add_hosts_update_and_trust:"新增域名需要更新证书并重新信任",api_add_hosts_update_cert:"新增域名需要更新证书",api_add_hosts_rm_keychain_failure:"卸载老的证书失败，请授权重试",api_add_hosts_update_default:"自签名证书要新增支持的域名，正在更新自签名证书",api_add_hosts_remove_cert_dir_failure:"删除存放原证书的目录失败，请授权重试",install_has_installed_delete_tip:"继续操作会覆盖该工具已创建的证书",install_del_installed_process_creating:"正在创建证书...",install_inquirer_domains_with_default:"输入启动本地HTTPS服务时使用的域名，多个以,分隔，直接回车将使用默认",install_inquirer_domains:"输入启动本地HTTPS服务时使用的域名，多个以,分隔，如abc.com,*.abc.com",install_create_key_cert_file_success:"成功创建密钥和自签名证书文件",install_create_key_cert_file_failure:"创建密钥和自签名证书文件失败",install_add_keychain_process_tip:"向系统的钥匙串里添加证书并始终信任...",install_add_keychain_success:"添加并信任成功，钥匙串里名称为：",install_add_keychain_failure:"钥匙串添加证书失败",install_over:"安装结束",install_over_extra_info:["","可随时通过下面命令查看自签名证书信息","$ trusted-cert","","安装证书的结果："],uninstall_unfound:"还没有安装过证书",uninstall_del_keychain:"正在删除钥匙串里名称「%s」的证书",uninstall_del_keychain_success:"删除成功",uninstall_del_keychain_failure:"删除失败，流程结束",uninstall_rm_dir_success:"已经删除存放密钥和证书的目录%s",uninstall_rm_dir_failure:"删除存放原证书的目录失败，流程结束",uninstall_complete:"删除完成"},Et=function(t){return Object.assign(Pt,t),Pt},$t=n("trusted-cert"),St=$(),Ot=St.sslCertificateDir,jt=St.sslKeyPath,Lt=St.sslCrtPath,Nt=St.CN,At=St.defaultDomains,Dt=Pt,Ft=function(){var t,e;return!!bt()||(console.warn(null!==(t=Dt.host_add_no_install)&&void 0!==t?t:"还没有安装自签名证书，运行下面命令安装使用"),console.warn(null!==(e=Dt.host_add_no_install_operation_tip)&&void 0!==e?e:"$ trusted-cert install"),!1)},Ct=function(){var t=h(y.mark((function t(){var r,n,o,i;return y.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return r=[{type:"input",name:"domains",message:At.length>0?Dt.install_inquirer_domains_with_default:Dt.install_inquirer_domains,default:At.join(",")}],t.next=3,e.prompt(r);case 3:if(n=t.sent,""===(o=n.domains)){t.next=9;break}i=o.split(",").map((function(t){return t.trim()})).filter(Boolean),t.next=10;break;case 9:return t.abrupt("return",[]);case 10:return i=i.reduce((function(t,e){return!t.includes(e)&&t.push(e),t}),[]),t.abrupt("return",i);case 12:case"end":return t.stop()}}),t)})));return function(){return t.apply(this,arguments)}}(),Tt=function(){var n=h(y.mark((function n(){var o,i,a,s,c,u,l,d,f,p,_,h,v;return y.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(a=tt(Nt),s=t.existsSync(Ot),0===a.length&&!s){n.next=17;break}return l=null!==(c=Dt.install_has_installed_delete_tip)&&void 0!==c?c:"继续操作会覆盖该工具已创建的证书",n.next=6,e.prompt([{type:"confirm",name:"continue",message:l,default:!1}]);case 6:if(d=n.sent,n.t0=d.continue,!n.t0){n.next=12;break}return n.next=11,Rt();case 11:n.t0=n.sent;case 12:if(n.t0){n.next=14;break}return n.abrupt("return",!1);case 14:if(d.continue){n.next=16;break}return n.abrupt("return",!1);case 16:console.log(null!==(u=Dt.install_del_installed_process_creating)&&void 0!==u?u:"正在创建证书...");case 17:return n.next=19,Ct();case 19:if(f=n.sent,n.prev=20,"true"!==process.env.NO_OPENSSL&&r("openssl")){n.next=26;break}return n.next=24,yt(f);case 24:n.next=30;break;case 26:return n.next=28,ht(f);case 28:return n.next=30,vt();case 30:console.log(null!==(p=Dt.install_create_key_cert_file_success)&&void 0!==p?p:"成功创建密钥和自签名证书文件"),n.next=36;break;case 33:n.prev=33,n.t1=n.catch(20),console.log(null!==(_=Dt.install_create_key_cert_file_failure)&&void 0!==_?_:"创建密钥和自签名证书文件失败");case 36:console.log(null!==(o=Dt.install_add_keychain_process_tip)&&void 0!==o?o:"向系统的钥匙串里添加证书并始终信任...");try{W(Lt),console.log(null!==(h=Dt.install_add_keychain_success)&&void 0!==h?h:"添加并信任成功，钥匙串里名称为：",Nt)}catch(t){console.warn(null!==(v=Dt.install_add_keychain_failure)&&void 0!==v?v:"钥匙串添加证书失败")}return console.log(null!==(i=Dt.install_over)&&void 0!==i?i:"安装结束"),Dt.install_over_extra_info.forEach((function(t){console.log(t)})),n.abrupt("return",Mt());case 41:case"end":return n.stop()}}),n,null,[[20,33]])})));return function(){return n.apply(this,arguments)}}(),Rt=function(){var e=h(y.mark((function e(){var r,n,o,i,a,s,c,u,l;return y.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=tt(Nt),o=t.existsSync(Ot),0!==n.length||o){e.next=5;break}return console.warn(null!==(i=Dt.uninstall_unfound)&&void 0!==i?i:"没有找到该工具安装的证书"),e.abrupt("return",!0);case 5:if(!(n.length>0)){e.next=17;break}return console.log(null!==(a=Dt.uninstall_del_keychain)&&void 0!==a?a:"正在删除钥匙串里名称「%s」的证书",Nt),e.prev=7,e.next=10,et(Nt);case 10:console.log(null!==(s=Dt.uninstall_del_keychain_success)&&void 0!==s?s:"删除成功"),e.next=17;break;case 13:return e.prev=13,e.t0=e.catch(7),console.error(null!==(c=Dt.uninstall_del_keychain_failure)&&void 0!==c?c:"删除失败，流程结束"),e.abrupt("return",!1);case 17:if(!o){e.next=28;break}return e.prev=18,e.next=21,kt(Ot);case 21:console.log(null!==(u=Dt.uninstall_rm_dir_success)&&void 0!==u?u:"已经删除存放密钥和证书的目录%s",Ot),e.next=28;break;case 24:return e.prev=24,e.t1=e.catch(18),console.log(null!==(l=Dt.uninstall_rm_dir_failure)&&void 0!==l?l:"删除存放原证书的目录失败，流程结束"),e.abrupt("return",!1);case 28:return console.log(null!==(r=Dt.uninstall_complete)&&void 0!==r?r:"删除完成"),e.abrupt("return",!0);case 30:case"end":return e.stop()}}),e,null,[[7,13],[18,24]])})));return function(){return e.apply(this,arguments)}}(),Ht=function(){var t=h(y.mark((function t(){var e,r,n,o,i,a,s,c;return y.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(Ft()){t.next=2;break}return t.abrupt("return",!1);case 2:if(e=tt(Nt),$t("已添加到钥匙串sha1列表 %o",e),r=wt(),$t("要新增的sha1是 %o",r),!e.includes(r)){t.next=14;break}return console.log(null!==(n=Dt.add_trust_repeat_add_tip)&&void 0!==n?n:"钥匙串里已经添加过，无须重复添加"),console.log(null!==(o=Dt.add_trust_keychain_cert_info)&&void 0!==o?o:"在钥匙串里证书的信息："),console.log(null!==(i=Dt.add_trust_keychain_cert_name)&&void 0!==i?i:"名称: ",Nt),console.log(null!==(a=Dt.add_trust_keychain_cert_sha1)&&void 0!==a?a:"sha-1: ",r),t.abrupt("return",!0);case 14:t.prev=14,W(Lt),console.log(null!==(s=Dt.add_trust_keychain_cert_success)&&void 0!==s?s:"添加并信任成功，钥匙串里名称是：",Nt),t.next=23;break;case 19:return t.prev=19,t.t0=t.catch(14),console.error(null!==(c=Dt.add_trust_failure)&&void 0!==c?c:"添加失败"),t.abrupt("return",!1);case 23:return t.abrupt("return",!0);case 24:case"end":return t.stop()}}),t,null,[[14,19]])})));return function(){return t.apply(this,arguments)}}(),It=function(){var t=h(y.mark((function t(){var e,r,n,o,i,a,s,c,u,l,d,f,p,_,h,v,m=arguments;return y.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(0!==(e=m.length>0&&void 0!==m[0]?m[0]:[]).length){t.next=4;break}return console.warn(null!==(r=Dt.host_add_no_input)&&void 0!==r?r:"输入要支持的host"),t.abrupt("return",!1);case 4:if(Ft()){t.next=6;break}return t.abrupt("return",!1);case 6:if(n=mt(),!U(n,e)){t.next=11;break}return console.warn(null!==(o=Dt.host_add_has_supported_no_needed_added)&&void 0!==o?o:"证书已经支持该域名，无须添加了"),t.abrupt("return",!0);case 11:return i=B(n,e),a=n.concat(i),(s=tt(Nt)).length>0?console.log(null!==(c=Dt.host_add_need_rebuild_and_trusted)&&void 0!==c?c:"新增域名需要更新证书并重新信任"):console.log(null!==(u=Dt.host_add_being_upgrading)&&void 0!==u?u:"正在更新证书"),t.prev=15,t.next=18,et(Nt);case 18:t.next=24;break;case 20:return t.prev=20,t.t0=t.catch(15),console.error(null!==(l=Dt.host_add_failure)&&void 0!==l?l:"新增域名失败"),t.abrupt("return",!1);case 24:return t.prev=24,t.next=27,kt(Ot);case 27:return t.next=29,ht(a);case 29:return t.next=31,vt();case 31:return s.length>0&&W(Lt),console.log(null!==(d=Dt.host_add_success)&&void 0!==d?d:"更新成功"),console.log(null!==(f=Dt.host_add_success_support_hosts)&&void 0!==f?f:"更新后支持的域名列表"),_=mt(),console.log(_.join(",")),console.log(null!==(p=Dt.host_add_cert_valid_period)&&void 0!==p?p:"更新后证书的起止有效时间："),console.log(gt()),0===s.length&&console.warn(null!==(h=Dt.host_add_trusted_suggestion)&&void 0!==h?h:"请运行 trusted-cert trust 信任证书"),t.abrupt("return",!0);case 42:return t.prev=42,t.t1=t.catch(24),console.error(null!==(v=Dt.host_add_failure)&&void 0!==v?v:"新增域名失败"),t.abrupt("return",!1);case 46:case"end":return t.stop()}}),t,null,[[15,20],[24,42]])})));return function(){return t.apply(this,arguments)}}();function Kt(t,e){return Gt.apply(this,arguments)}function Gt(){return(Gt=h(y.mark((function e(n,o){var i,a,s,c,u,l,d,f,p,_,h,v;return y.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=!1,Array.isArray(n)||"string"==typeof n?i=null!==(c=null==o?void 0:o.silent)&&void 0!==c&&c:(i=null!==(a=null===(s=n)||void 0===s?void 0:s.silent)&&void 0!==a&&a,n=At),"string"==typeof n&&(n=[n]),!(u=bt())||!U(mt(),n)){e.next=8;break}$t("之前已经添加过域名，跳过返回之前的域名");try{xt()||(console.log("创建自签名证书"),W(Lt)),l=!0}catch(t){l=!1}return e.abrupt("return",{key:t.readFileSync(jt),cert:t.readFileSync(Lt),keyFilePath:jt,certFilePath:Lt,trusted:l});case 8:if(console.log("创建自签名证书"),!u){e.next=30;break}return d=mt(),tt(Nt).length>0?!i&&console.log(null!==(f=Dt.api_add_hosts_update_and_trust)&&void 0!==f?f:"新增域名需要更新证书并重新信任"):!i&&console.log(null!==(p=Dt.api_add_hosts_update_cert)&&void 0!==p?p:"新增域名需要更新证书"),e.prev=13,e.next=16,et(Nt);case 16:e.next=21;break;case 18:throw e.prev=18,e.t0=e.catch(13),new Error(null!==(_=Dt.api_add_hosts_rm_keychain_failure)&&void 0!==_?_:"卸载老的证书失败，请授权重试");case 21:return e.prev=21,e.next=24,kt(Ot);case 24:e.next=29;break;case 26:throw e.prev=26,e.t1=e.catch(21),new Error(null!==(h=Dt.api_add_hosts_remove_cert_dir_failure)&&void 0!==h?h:"删除存放原证书的目录失败，请授权重试");case 29:n=d.concat(B(d,n));case 30:if("true"!==process.env.NO_OPENSSL&&r("openssl")){e.next=35;break}return e.next=33,yt(n);case 33:e.next=39;break;case 35:return e.next=37,ht(n);case 37:return e.next=39,vt();case 39:try{xt()||W(Lt),v=!0}catch(t){v=!1}return e.abrupt("return",{key:t.readFileSync(jt),cert:t.readFileSync(Lt),keyFilePath:jt,certFilePath:Lt,trusted:v});case 41:case"end":return e.stop()}}),e,null,[[13,18],[21,26]])})))).apply(this,arguments)}var Mt=function(){var t,e,r,n;if(!Ft())return!1;var o=mt();console.log(null!==(t=Dt.info_ssl_key_path)&&void 0!==t?t:"密钥文件路径：",jt),console.log(null!==(e=Dt.info_ssl_cert_path)&&void 0!==e?e:"自签名证书文件路径：",Lt),console.log(null!==(r=Dt.info_ssl_cert_support_hosts)&&void 0!==r?r:"自签名证书已经支持的域名：",o.join(",")),console.log(null!==(n=Dt.info_ssl_cert_valid_period)&&void 0!==n?n:"自签名证书的有效时间：",gt());var i,a,s,c,u,l=tt(Nt),d=wt();l.includes(d)?(console.log(null!==(i=Dt.info_ssl_cert_trusted_desc)&&void 0!==i?i:"自签名证书已经添加到钥匙串并被始终信任"),console.log(null!==(a=Dt.info_keychains_cert_name)&&void 0!==a?a:"自签名证书在钥匙串里的名称：",Nt,", ",null!==(s=Dt.info_keychains_cert_sha1)&&void 0!==s?s:"自签名证书在钥匙串里的sha-1：",d)):(console.log(null!==(c=Dt.info_ssl_cert_not_trusted)&&void 0!==c?c:"自签名证书还没被添加到钥匙串，可以运行下面命令，执行添加和始终信任"),console.log(null!==(u=Dt.info_ssl_cert_trusted_cli_tip)&&void 0!==u?u:"$ trusted-cert trust"));return Dt.info_extra_help.forEach((function(t){console.log(t)})),!0};export{It as addHosts,Kt as certificateFor,Ht as doTrust,Mt as info,Tt as install,Et as mergeLan,E as setConfig,Rt as uninstall};
